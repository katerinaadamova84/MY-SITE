<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–õ–∏–Ω–∏—è –Ω–∞ –≤—Ä–µ–º–µ—Ç–æ ‚Äì –ë—ä–ª–≥–∞—Ä–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9922a;
    --gold-light: #f0c060;
    --gold-dark: #7a5414;
    --parchment: #f5e8c8;
    --parchment-dark: #e0c89a;
    --ink: #1a0f05;
    --ink-light: #3a2010;
    --red: #8b1a1a;
    --green-ok: #2a6b2a;
    --bg-dark: #0e0804;
    --border: #c9922a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background-color: var(--bg-dark);
    background-image:
      radial-gradient(ellipse at 20% 20%, #2a1a0a 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, #1a0a00 0%, transparent 60%);
    min-height: 100vh;
    font-family: 'IM Fell English', serif;
    color: var(--parchment);
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ DECORATIVE FRAME ‚îÄ‚îÄ */
  .page-frame {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
  }

  .corner {
    position: fixed;
    width: 80px; height: 80px;
    opacity: .55;
    pointer-events: none;
    z-index: 100;
  }
  .corner svg { width: 100%; height: 100%; }
  .tl { top: 0; left: 0; }
  .tr { top: 0; right: 0; transform: scaleX(-1); }
  .bl { bottom: 0; left: 0; transform: scaleY(-1); }
  .br { bottom: 0; right: 0; transform: scale(-1); }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    text-align: center;
    padding: 30px 20px 20px;
    position: relative;
  }

  .header h1 {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.4rem, 4vw, 2.4rem);
    font-weight: 700;
    color: var(--gold-light);
    text-shadow: 0 0 20px rgba(201,146,42,.5), 2px 2px 4px rgba(0,0,0,.8);
    letter-spacing: .08em;
    line-height: 1.2;
  }

  .header p {
    margin-top: 8px;
    font-style: italic;
    color: var(--parchment-dark);
    font-size: .95rem;
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
  }
  .divider-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--gold), transparent);
  }
  .divider-gem {
    width: 10px; height: 10px;
    background: var(--gold);
    transform: rotate(45deg);
    box-shadow: 0 0 8px var(--gold-light);
  }

  /* ‚îÄ‚îÄ SCORE BAR ‚îÄ‚îÄ */
  .score-bar {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
    padding: 10px 0;
  }

  .score-pill {
    background: rgba(201,146,42,.12);
    border: 1px solid rgba(201,146,42,.4);
    border-radius: 4px;
    padding: 6px 18px;
    font-family: 'Cinzel', serif;
    font-size: .85rem;
    color: var(--gold-light);
    letter-spacing: .05em;
  }

  .score-pill span {
    color: #fff;
    font-weight: 700;
  }

  /* ‚îÄ‚îÄ GAME MODES ‚îÄ‚îÄ */
  .mode-select {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 20px 0;
  }

  .mode-btn {
    background: linear-gradient(135deg, #2a1a05, #1a0e02);
    border: 1px solid rgba(201,146,42,.5);
    color: var(--gold-light);
    font-family: 'Cinzel', serif;
    font-size: .8rem;
    padding: 8px 18px;
    border-radius: 4px;
    cursor: pointer;
    letter-spacing: .06em;
    transition: all .25s;
  }
  .mode-btn:hover, .mode-btn.active {
    background: linear-gradient(135deg, var(--gold-dark), #5a3a10);
    border-color: var(--gold-light);
    color: #fff;
    box-shadow: 0 0 12px rgba(201,146,42,.35);
  }

  /* ‚îÄ‚îÄ GAME AREA ‚îÄ‚îÄ */
  .game-area {
    background: linear-gradient(145deg, #1a0f05, #0e0804);
    border: 1px solid rgba(201,146,42,.3);
    border-radius: 8px;
    padding: 28px;
    margin: 8px 0 20px;
    box-shadow: inset 0 0 40px rgba(0,0,0,.5), 0 4px 20px rgba(0,0,0,.6);
    min-height: 320px;
    position: relative;
  }

  /* ‚îÄ‚îÄ QUESTION PANEL ‚îÄ‚îÄ */
  .question-header {
    font-family: 'Cinzel', serif;
    font-size: .78rem;
    color: var(--gold);
    letter-spacing: .12em;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .question-text {
    font-size: clamp(1rem, 2.5vw, 1.25rem);
    color: var(--parchment);
    line-height: 1.6;
    margin-bottom: 24px;
    text-shadow: 1px 1px 3px rgba(0,0,0,.7);
  }

  .question-text strong {
    color: var(--gold-light);
  }

  /* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
  .progress-wrap {
    height: 4px;
    background: rgba(255,255,255,.1);
    border-radius: 2px;
    margin-bottom: 20px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(to right, var(--gold-dark), var(--gold-light));
    border-radius: 2px;
    transition: width .5s ease;
  }

  /* ‚îÄ‚îÄ ANSWER CHOICES ‚îÄ‚îÄ */
  .choices {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  @media(max-width:560px) {
    .choices { grid-template-columns: 1fr; }
  }

  .choice-btn {
    background: linear-gradient(135deg, #281600, #180d00);
    border: 1px solid rgba(201,146,42,.35);
    color: var(--parchment);
    font-family: 'IM Fell English', serif;
    font-size: .95rem;
    padding: 14px 16px;
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    transition: all .2s;
    position: relative;
    overflow: hidden;
    line-height: 1.4;
  }

  .choice-btn::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--gold);
    opacity: 0;
    transition: opacity .2s;
  }

  .choice-btn:hover:not(:disabled) {
    border-color: var(--gold);
    background: linear-gradient(135deg, #3a2008, #281400);
    transform: translateX(3px);
    box-shadow: 0 4px 16px rgba(0,0,0,.4);
  }
  .choice-btn:hover:not(:disabled)::before { opacity: 1; }

  .choice-btn.correct {
    background: linear-gradient(135deg, #0d2b0d, #071507);
    border-color: #4caf50;
    color: #a5d6a7;
    box-shadow: 0 0 16px rgba(76,175,80,.25);
  }
  .choice-btn.correct::before { background: #4caf50; opacity: 1; }

  .choice-btn.wrong {
    background: linear-gradient(135deg, #2b0d0d, #150707);
    border-color: #f44336;
    color: #ef9a9a;
    box-shadow: 0 0 16px rgba(244,67,54,.2);
    animation: shake .4s ease;
  }
  .choice-btn.wrong::before { background: #f44336; opacity: 1; }

  .choice-btn:disabled { cursor: default; }

  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  /* ‚îÄ‚îÄ DRAG-DROP TIMELINE ‚îÄ‚îÄ */
  .timeline-container { position: relative; }

  .timeline-instructions {
    font-style: italic;
    color: var(--parchment-dark);
    font-size: .88rem;
    margin-bottom: 16px;
  }

  .cards-pool {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    min-height: 60px;
    padding: 10px;
    background: rgba(0,0,0,.3);
    border: 1px dashed rgba(201,146,42,.3);
    border-radius: 6px;
  }

  .event-card {
    background: linear-gradient(135deg, #3a2205, #281500);
    border: 1px solid rgba(201,146,42,.5);
    color: var(--parchment);
    font-family: 'IM Fell English', serif;
    font-size: .85rem;
    padding: 8px 14px;
    border-radius: 4px;
    cursor: grab;
    user-select: none;
    transition: all .2s;
    max-width: 200px;
  }
  .event-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.5); }
  .event-card.dragging { opacity: .5; cursor: grabbing; }

  .timeline-slots {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .timeline-slot {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .slot-date {
    font-family: 'Cinzel', serif;
    font-size: .85rem;
    color: var(--gold);
    min-width: 70px;
    text-align: right;
    white-space: nowrap;
  }

  .slot-line {
    width: 20px;
    height: 1px;
    background: var(--gold);
    flex-shrink: 0;
  }
  .slot-dot {
    width: 10px; height: 10px;
    border: 2px solid var(--gold);
    border-radius: 50%;
    background: var(--bg-dark);
    flex-shrink: 0;
  }

  .slot-drop {
    flex: 1;
    min-height: 44px;
    border: 1px dashed rgba(201,146,42,.4);
    border-radius: 4px;
    padding: 6px 10px;
    display: flex;
    align-items: center;
    transition: all .2s;
    background: rgba(0,0,0,.2);
  }
  .slot-drop.drag-over {
    background: rgba(201,146,42,.15);
    border-color: var(--gold);
  }
  .slot-drop.filled-correct { border-color: #4caf50; background: rgba(76,175,80,.1); }
  .slot-drop.filled-wrong   { border-color: #f44336; background: rgba(244,67,54,.1); }

  /* ‚îÄ‚îÄ MATCH GAME ‚îÄ‚îÄ */
  .match-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .match-col-header {
    font-family: 'Cinzel', serif;
    font-size: .75rem;
    color: var(--gold);
    letter-spacing: .1em;
    text-align: center;
    margin-bottom: 8px;
    text-transform: uppercase;
  }

  .match-item {
    background: linear-gradient(135deg, #281600, #1a0d00);
    border: 1px solid rgba(201,146,42,.35);
    color: var(--parchment);
    font-family: 'IM Fell English', serif;
    font-size: .9rem;
    padding: 10px 14px;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 8px;
    transition: all .2s;
    line-height: 1.4;
  }
  .match-item:hover { border-color: var(--gold); }
  .match-item.selected { border-color: var(--gold-light); background: linear-gradient(135deg, #3a2205, #281400); box-shadow: 0 0 10px rgba(201,146,42,.3); }
  .match-item.matched-correct { border-color: #4caf50; background: rgba(76,175,80,.08); color: #a5d6a7; }
  .match-item.matched-wrong { border-color: #f44336; animation: shake .4s ease; }

  /* ‚îÄ‚îÄ FEEDBACK PANEL ‚îÄ‚îÄ */
  .feedback {
    margin-top: 20px;
    padding: 14px 18px;
    border-radius: 6px;
    font-size: .95rem;
    line-height: 1.5;
    display: none;
    animation: fadeSlideIn .35s ease;
  }
  .feedback.show { display: block; }
  .feedback.correct-fb {
    background: rgba(76,175,80,.1);
    border: 1px solid rgba(76,175,80,.4);
    color: #a5d6a7;
  }
  .feedback.wrong-fb {
    background: rgba(244,67,54,.08);
    border: 1px solid rgba(244,67,54,.3);
    color: #ef9a9a;
  }

  .feedback-icon { font-size: 1.3em; margin-right: 6px; }

  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ NEXT BUTTON ‚îÄ‚îÄ */
  .next-btn {
    display: block;
    margin: 20px auto 0;
    background: linear-gradient(135deg, var(--gold-dark), #7a5010);
    border: 1px solid var(--gold);
    color: var(--parchment);
    font-family: 'Cinzel', serif;
    font-size: .9rem;
    letter-spacing: .08em;
    padding: 12px 32px;
    border-radius: 5px;
    cursor: pointer;
    transition: all .2s;
    box-shadow: 0 4px 16px rgba(0,0,0,.5);
    display: none;
  }
  .next-btn:hover {
    background: linear-gradient(135deg, #8a6020, #9a7030);
    box-shadow: 0 0 18px rgba(201,146,42,.4);
    transform: translateY(-1px);
  }
  .next-btn.visible { display: block; }

  /* ‚îÄ‚îÄ RESULTS SCREEN ‚îÄ‚îÄ */
  .results-screen {
    text-align: center;
    padding: 30px 20px;
    animation: fadeSlideIn .5s ease;
  }

  .results-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.4rem, 4vw, 2rem);
    color: var(--gold-light);
    margin-bottom: 8px;
    text-shadow: 0 0 15px rgba(201,146,42,.4);
  }

  .results-score-big {
    font-family: 'Cinzel', serif;
    font-size: clamp(2.5rem, 8vw, 4rem);
    color: var(--gold);
    text-shadow: 0 0 30px rgba(201,146,42,.5);
    margin: 12px 0;
  }

  .results-comment {
    font-style: italic;
    font-size: 1.05rem;
    color: var(--parchment-dark);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .medal {
    font-size: 3rem;
    display: block;
    margin: 10px auto;
    animation: pulse 1.5s ease infinite;
  }

  @keyframes pulse {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .restart-btn {
    background: linear-gradient(135deg, var(--red), #5a1010);
    border: 1px solid #c04040;
    color: var(--parchment);
    font-family: 'Cinzel', serif;
    font-size: .9rem;
    padding: 12px 30px;
    border-radius: 5px;
    cursor: pointer;
    margin: 0 8px;
    transition: all .2s;
    letter-spacing: .06em;
  }
  .restart-btn:hover { box-shadow: 0 0 16px rgba(139,26,26,.5); transform: translateY(-1px); }

  /* ‚îÄ‚îÄ HINT ‚îÄ‚îÄ */
  .hint-btn {
    background: none;
    border: 1px solid rgba(201,146,42,.3);
    color: rgba(201,146,42,.7);
    font-family: 'IM Fell English', serif;
    font-size: .8rem;
    padding: 5px 14px;
    border-radius: 4px;
    cursor: pointer;
    transition: all .2s;
    float: right;
  }
  .hint-btn:hover { border-color: var(--gold); color: var(--gold); }

  .hint-text {
    display: none;
    margin-top: 12px;
    padding: 10px 14px;
    background: rgba(201,146,42,.06);
    border-left: 3px solid var(--gold-dark);
    font-style: italic;
    font-size: .88rem;
    color: var(--parchment-dark);
    border-radius: 0 4px 4px 0;
  }
  .hint-text.visible { display: block; animation: fadeSlideIn .3s; }

  /* ‚îÄ‚îÄ CHECK BUTTON for drag-drop ‚îÄ‚îÄ */
  .check-btn {
    background: linear-gradient(135deg, #0d3a2a, #062018);
    border: 1px solid #2e7d52;
    color: #a5d6b7;
    font-family: 'Cinzel', serif;
    font-size: .85rem;
    padding: 10px 24px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 14px;
    transition: all .2s;
    letter-spacing: .06em;
  }
  .check-btn:hover { box-shadow: 0 0 12px rgba(46,125,82,.4); }

  /* ‚îÄ‚îÄ AUDIO TOGGLE ‚îÄ‚îÄ */
  .audio-note {
    text-align: center;
    font-size: .75rem;
    color: rgba(201,146,42,.45);
    font-style: italic;
    margin-top: -8px;
    margin-bottom: 10px;
  }

  /* ‚îÄ‚îÄ STARS ‚îÄ‚îÄ */
  .stars-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 14px 0;
  }
  .star {
    font-size: 2rem;
    color: #555;
    transition: color .4s, transform .4s;
  }
  .star.lit {
    color: var(--gold-light);
    text-shadow: 0 0 12px var(--gold);
    transform: scale(1.15);
  }

  /* ‚îÄ‚îÄ GAME OVER DETAILS ‚îÄ‚îÄ */
  .review-list {
    text-align: left;
    margin: 20px auto;
    max-width: 600px;
  }
  .review-item {
    padding: 10px 14px;
    margin-bottom: 8px;
    border-radius: 4px;
    font-size: .9rem;
    line-height: 1.5;
  }
  .review-item.r-correct { background: rgba(76,175,80,.08); border-left: 3px solid #4caf50; }
  .review-item.r-wrong   { background: rgba(244,67,54,.08); border-left: 3px solid #f44336; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #0e0804; }
  ::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 3px; }
</style>
</head>
<body>

<!-- Corner ornaments -->
<div class="corner tl"><svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 2 L30 2 L30 6 L6 6 L6 30 L2 30 Z" fill="#c9922a"/><path d="M10 10 L25 10 L25 13 L13 13 L13 25 L10 25 Z" fill="#c9922a" opacity=".5"/><circle cx="5" cy="5" r="3" fill="#c9922a"/><path d="M32 4 L50 4" stroke="#c9922a" stroke-width="1.5"/><path d="M4 32 L4 50" stroke="#c9922a" stroke-width="1.5"/></svg></div>
<div class="corner tr"><svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 2 L30 2 L30 6 L6 6 L6 30 L2 30 Z" fill="#c9922a"/><path d="M10 10 L25 10 L25 13 L13 13 L13 25 L10 25 Z" fill="#c9922a" opacity=".5"/><circle cx="5" cy="5" r="3" fill="#c9922a"/><path d="M32 4 L50 4" stroke="#c9922a" stroke-width="1.5"/><path d="M4 32 L4 50" stroke="#c9922a" stroke-width="1.5"/></svg></div>
<div class="corner bl"><svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 2 L30 2 L30 6 L6 6 L6 30 L2 30 Z" fill="#c9922a"/><path d="M10 10 L25 10 L25 13 L13 13 L13 25 L10 25 Z" fill="#c9922a" opacity=".5"/><circle cx="5" cy="5" r="3" fill="#c9922a"/><path d="M32 4 L50 4" stroke="#c9922a" stroke-width="1.5"/><path d="M4 32 L4 50" stroke="#c9922a" stroke-width="1.5"/></svg></div>
<div class="corner br"><svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 2 L30 2 L30 6 L6 6 L6 30 L2 30 Z" fill="#c9922a"/><path d="M10 10 L25 10 L25 13 L13 13 L13 25 L10 25 Z" fill="#c9922a" opacity=".5"/><circle cx="5" cy="5" r="3" fill="#c9922a"/><path d="M32 4 L50 4" stroke="#c9922a" stroke-width="1.5"/><path d="M4 32 L4 50" stroke="#c9922a" stroke-width="1.5"/></svg></div>

<div class="page-frame">
  <div class="header">
    <h1>‚öî –õ–∏–Ω–∏—è –Ω–∞ –í—Ä–µ–º–µ—Ç–æ ‚öî<br><span style="font-size:.65em;font-weight:400;letter-spacing:.04em">–†–∞–Ω–Ω–∞ –°—Ä–µ–¥–Ω–æ–≤–µ–∫–æ–≤–Ω–∞ –ë—ä–ª–≥–∞—Ä–∏—è</span></h1>
    <p>–ü—Ä–æ–≤–µ—Ä–∏ –∑–Ω–∞–Ω–∏—è—Ç–∞ —Å–∏ –∑–∞ –ø—ä—Ä–≤–∏—Ç–µ –≤–ª–∞–¥–µ—Ç–µ–ª–∏ –∏ —Å—ä–±–∏—Ç–∏—è—Ç–∞ –æ—Ç –Ω–∞—à–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è</p>
  </div>

  <div class="divider"><div class="divider-line"></div><div class="divider-gem"></div><div class="divider-line"></div></div>

  <div class="score-bar" id="scoreBar">
    <div class="score-pill">–¢–æ—á–∫–∏: <span id="scoreDisplay">0</span></div>
    <div class="score-pill">–í—ä–ø—Ä–æ—Å: <span id="qNumDisplay">1</span> / <span id="qTotalDisplay">10</span></div>
    <div class="score-pill">–ü—Ä–∞–≤–∏–ª–Ω–∏: <span id="correctDisplay">0</span></div>
    <div class="score-pill">–ì—Ä–µ—à–Ω–∏: <span id="wrongDisplay">0</span></div>
  </div>

  <div class="mode-select">
    <button class="mode-btn active" onclick="setMode('quiz')" id="btnQuiz">üìú –¢–µ—Å—Ç</button>
    <button class="mode-btn" onclick="setMode('timeline')" id="btnTimeline">‚è≥ –ù–∞—Ä–µ–¥–∏</button>
    <button class="mode-btn" onclick="setMode('match')" id="btnMatch">üîó –°–≤—ä—Ä–∂–∏</button>
  </div>

  <div class="game-area" id="gameArea">
    <!-- Rendered by JS -->
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const events = [
  { year: 635,  ruler: "–•–∞–Ω –ö—É–±—Ä–∞—Ç",   event: "–û–±–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∞–±—ä–ª–≥–∞—Ä—Å–∫–∏—Ç–µ –ø–ª–µ–º–µ–Ω–∞ –≤ –°—Ç–∞—Ä–∞ –í–µ–ª–∏–∫–∞ –ë—ä–ª–≥–∞—Ä–∏—è", hint: "–ï–¥–∏–Ω—Å—Ç–≤–æ –µ —Å–∏–ª–∞ ‚Äì –≤—Å–ø–æ–º–Ω–∏ –ø—Ä–∏—Ç—á–∞—Ç–∞ –∑–∞ —Å–Ω–æ–ø–∞ –ø—Ä—ä—á–∫–∏." },
  { year: 680,  ruler: "–•–∞–Ω –ê—Å–ø–∞—Ä—É—Ö",  event: "–†–∞–∑–≥—Ä–æ–º –Ω–∞ –í–∏–∑–∞–Ω—Ç–∏–π—Å–∫–∞—Ç–∞ –∞—Ä–º–∏—è –≤ –û–Ω–≥—ä–ª–∞",                     hint: "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ—Ç–æ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –û–Ω–≥—ä–ª –¥–∞–≤–∞–ª–æ –∑–∞—â–∏—Ç–∞ –∏ –ª–µ—Å–Ω–∞ –æ—Ç–±—Ä–∞–Ω–∞." },
  { year: 681,  ruler: "–•–∞–Ω –ê—Å–ø–∞—Ä—É—Ö",  event: "–°–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –º–∏—Ä–µ–Ω –¥–æ–≥–æ–≤–æ—Ä —Å –í–∏–∑–∞–Ω—Ç–∏—è ‚Äì –æ—Ñ–∏—Ü–∏–∞–ª–Ω–æ –ø—Ä–∏–∑–Ω–∞–≤–∞–Ω–µ –Ω–∞ –ë—ä–ª–≥–∞—Ä–∏—è", hint: "–¢–∞–∑–∏ –¥–∞—Ç–∞ –µ –Ω–∞—á–∞–ª–æ—Ç–æ –Ω–∞ –ü—ä—Ä–≤–æ—Ç–æ –ë—ä–ª–≥–∞—Ä—Å–∫–æ —Ü–∞—Ä—Å—Ç–≤–æ." },
  { year: 701,  ruler: "–•–∞–Ω –¢–µ—Ä–≤–µ–ª",   event: "–•–∞–Ω –¢–µ—Ä–≤–µ–ª –ø–æ–º–∞–≥–∞ –Ω–∞ –Æ—Å—Ç–∏–Ω–∏–∞–Ω II –¥–∞ —Å–∏ –≤—ä—Ä–Ω–µ –ø—Ä–µ—Å—Ç–æ–ª–∞",       hint: "–í –∑–Ω–∞–∫ –Ω–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç –ë—ä–ª–≥–∞—Ä–∏—è –ø–æ–ª—É—á–∏–ª–∞ –æ–±–ª–∞—Å—Ç—Ç–∞ –ó–∞–≥–æ—Ä–µ." },
  { year: 711,  ruler: "–•–∞–Ω –¢–µ—Ä–≤–µ–ª",   event: "–¢–µ—Ä–≤–µ–ª –ø–æ–ª—É—á–∞–≤–∞ —Ç–∏—Ç–ª–∞—Ç–∞ '–∫–µ—Å–∞—Ä' –æ—Ç –Æ—Å—Ç–∏–Ω–∏–∞–Ω II",             hint: "–ö–µ—Å–∞—Ä –µ –≤—Ç–æ—Ä–æ—Ç–æ –ø–æ –≤–∞–∂–Ω–æ—Å—Ç –∑–≤–∞–Ω–∏–µ —Å–ª–µ–¥ –∏–º–ø–µ—Ä–∞—Ç–æ—Ä–∞." },
  { year: 718,  ruler: "–•–∞–Ω –¢–µ—Ä–≤–µ–ª",   event: "–¢–µ—Ä–≤–µ–ª —Ä–∞–∑–≥—Ä–æ–º—è–≤–∞ –∞—Ä–∞–±—Å–∫–∞—Ç–∞ –∞—Ä–º–∏—è –∏ —Å–ø–∞—Å—è–≤–∞ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–ø–æ–ª ‚Äì \"–°–ø–∞—Å–∏—Ç–µ–ª—è—Ç –Ω–∞ –ï–≤—Ä–æ–ø–∞\"", hint: "–ê—Ä–∞–±–∏—Ç–µ –æ–±—Å–∞–∂–¥–∞–ª–∏ –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω–æ–ø–æ–ª —Ü—è–ª–∞ –≥–æ–¥–∏–Ω–∞ –ø–æ —Å—É—à–∞ –∏ –º–æ—Ä–µ." },
  { year: 803,  ruler: "–•–∞–Ω –ö—Ä—É–º",     event: "–•–∞–Ω –ö—Ä—É–º –∑–∞–µ–º–∞ –ø—Ä–µ—Å—Ç–æ–ª–∞ –∏ —É–Ω–∏—â–æ–∂–∞–≤–∞ –ê–≤–∞—Ä—Å–∫–∞—Ç–∞ –¥—ä—Ä–∂–∞–≤–∞",       hint: "–•–∞–Ω –ö—Ä—É–º —Ä–∞–∑—à–∏—Ä–∏–ª –ë—ä–ª–≥–∞—Ä–∏—è –Ω–∞ –Æ–≥ –∏ –ó–∞–ø–∞–¥." },
  { year: 811,  ruler: "–•–∞–Ω –ö—Ä—É–º",     event: "–ü–æ–±–µ–¥–∞ –Ω–∞–¥ –ù–∏–∫–∏—Ñ–æ—Ä I –ø—Ä–∏ –í—ä—Ä–±–∏—à–∫–∏—è –ø—Ä–æ—Ö–æ–¥",                   hint: "–ù–∏–∫–∏—Ñ–æ—Ä –Ω–∞—Ä–µ–¥–∏–ª –¥–∞ –∏–∑–≥–æ—Ä—è—Ç –ü–ª–∏—Å–∫–∞, –Ω–æ –∑–∞–ø–ª–∞—Ç–∏ —Å –∂–∏–≤–æ—Ç–∞ —Å–∏." },
  { year: 864,  ruler: "–•–∞–Ω –ë–æ—Ä–∏—Å I",  event: "–ü–æ–∫—Ä—ä—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ö–∞–Ω –ë–æ—Ä–∏—Å I ‚Äì –ë—ä–ª–≥–∞—Ä–∏—è –ø—Ä–∏–µ–º–∞ —Ö—Ä–∏—Å—Ç–∏—è–Ω—Å—Ç–≤–æ—Ç–æ", hint: "–ë–æ—Ä–∏—Å –ø—Ä–∏–µ–ª –∫—Ä—ä—â–µ–Ω–∏–µ –≤ –ü–ª–∏—Å–∫–∞ –æ—Ç –≤–∏–∑–∞–Ω—Ç–∏–π—Å–∫–∏ —Å–≤–µ—â–µ–Ω–∏—Ü–∏." },
  { year: 870,  ruler: "–•–∞–Ω –ë–æ—Ä–∏—Å I",  event: "–°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–∞—Ç–∞ –ë—ä–ª–≥–∞—Ä—Å–∫–∞ –ø—Ä–∞–≤–æ—Å–ª–∞–≤–Ω–∞ —Ü—ä—Ä–∫–≤–∞",   hint: "–ë–æ—Ä–∏—Å I –≤–æ–¥–∏–ª –¥–∏–ø–ª–æ–º–∞—Ü–∏—è –µ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –†–∏–º –∏ –¶–∞—Ä–∏–≥—Ä–∞–¥." },
  { year: 855,  ruler: "–ö–∏—Ä–∏–ª –∏ –ú–µ—Ç–æ–¥–∏–π", event: "–ö–∏—Ä–∏–ª –∏ –ú–µ—Ç–æ–¥–∏–π —Å—ä–∑–¥–∞–≤–∞—Ç –≥–ª–∞–≥–æ–ª–∏—Ü–∞—Ç–∞",                   hint: "–î–≤–∞–º–∞—Ç–∞ –±—Ä–∞—Ç—è —Å–∞ —Ä–æ–¥–µ–Ω–∏ –≤ –°–æ–ª—É–Ω." },
  { year: 886,  ruler: "–•–∞–Ω –ë–æ—Ä–∏—Å I",  event: "–ë–æ—Ä–∏—Å I –ø—Ä–∏–µ–º–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –Ω–∞ –ö–∏—Ä–∏–ª –∏ –ú–µ—Ç–æ–¥–∏–π –≤ –ë—ä–ª–≥–∞—Ä–∏—è",     hint: "–ö–ª–∏–º–µ–Ω—Ç –±–∏–ª –∏–∑–ø—Ä–∞—Ç–µ–Ω –≤ –û—Ö—Ä–∏–¥, –∞ –ù–∞—É–º –≤ –ü–ª–∏—Å–∫–∞." },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mode       = 'quiz';
let score      = 0;
let correct    = 0;
let wrong      = 0;
let qIndex     = 0;
let questions  = [];
let answered   = false;
let userLog    = [];  // {q, correct}

let dragItem   = null;
let matchSel   = { left: null, right: null };
let matchDone  = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(m) {
  mode = m;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('btn' + m.charAt(0).toUpperCase() + m.slice(1)).classList.add('active');
  resetGame();
}

function resetGame() {
  score = 0; correct = 0; wrong = 0; qIndex = 0;
  userLog = [];
  answered = false;
  matchSel = { left: null, right: null };
  matchDone = {};
  buildQuestions();
  updateScoreBar();
  renderQuestion();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUIZ QUESTIONS BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function buildQuestions() {
  if (mode === 'quiz') {
    // Mix of 3 question types
    const pool = shuffle(events).slice(0, 10);
    questions = pool.map((ev, idx) => {
      const type = idx % 3;
      if (type === 0) return makeYearQ(ev);
      if (type === 1) return makeRulerQ(ev);
      return makeEventQ(ev);
    });
  } else if (mode === 'timeline') {
    questions = [buildTimelineQ()];
  } else if (mode === 'match') {
    questions = buildMatchRounds();
  }
  document.getElementById('qTotalDisplay').textContent = mode === 'quiz' ? questions.length : (mode === 'match' ? questions.length : 1);
}

function makeYearQ(ev) {
  const wrongYears = events.filter(e => e.year !== ev.year).map(e => e.year);
  const opts = shuffle([ev.year, ...shuffle(wrongYears).slice(0, 3)]).map(String);
  return {
    type: 'mcq',
    q: `–í –∫–æ—è –≥–æ–¥–∏–Ω–∞ ${ev.event.toLowerCase().replace(/^[–∞-—è–ê-–Ø]/, c => c.toLowerCase())}?`,
    answer: String(ev.year),
    options: opts,
    hint: ev.hint,
    ruler: ev.ruler,
    ev: ev
  };
}

function makeRulerQ(ev) {
  const rulers = [...new Set(events.map(e => e.ruler))];
  const wrongRulers = shuffle(rulers.filter(r => r !== ev.ruler)).slice(0, 3);
  const opts = shuffle([ev.ruler, ...wrongRulers]);
  return {
    type: 'mcq',
    q: `–ö–æ–π –≤–ª–∞–¥–µ—Ç–µ–ª ${ev.event.toLowerCase().replace(/^[–∞-—è–ê-–Ø]/, c => c.toLowerCase())}?`,
    answer: ev.ruler,
    options: opts,
    hint: ev.hint,
    year: ev.year,
    ev: ev
  };
}

function makeEventQ(ev) {
  const wrongEvents = shuffle(events.filter(e => e.year !== ev.year)).slice(0, 3).map(e => e.event);
  const opts = shuffle([ev.event, ...wrongEvents]);
  return {
    type: 'mcq',
    q: `–ö–æ–µ —Å—ä–±–∏—Ç–∏–µ –µ —Å–≤—ä—Ä–∑–∞–Ω–æ —Å <strong>${ev.ruler}</strong> –∏ –≥–æ–¥–∏–Ω–∞—Ç–∞ <strong>${ev.year} –≥.</strong>?`,
    answer: ev.event,
    options: opts,
    hint: ev.hint,
    ev: ev
  };
}

function buildTimelineQ() {
  const selected = shuffle(events).slice(0, 6);
  return {
    type: 'timeline',
    items: selected,
    sorted: [...selected].sort((a, b) => a.year - b.year)
  };
}

function buildMatchRounds() {
  const rounds = [];
  const pool = shuffle(events);
  for (let i = 0; i < 3; i++) {
    const chunk = pool.slice(i * 4, i * 4 + 4);
    if (chunk.length < 2) break;
    rounds.push({
      type: 'match',
      pairs: chunk.map(ev => ({ left: `${ev.year} –≥.`, right: ev.event, ruler: ev.ruler, hint: ev.hint }))
    });
  }
  return rounds;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateScoreBar() {
  document.getElementById('scoreDisplay').textContent = score;
  document.getElementById('qNumDisplay').textContent = qIndex + 1;
  document.getElementById('correctDisplay').textContent = correct;
  document.getElementById('wrongDisplay').textContent = wrong;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER DISPATCHER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderQuestion() {
  const area = document.getElementById('gameArea');
  if (qIndex >= questions.length) {
    renderResults();
    return;
  }
  const q = questions[qIndex];
  updateScoreBar();

  if (q.type === 'mcq') renderMCQ(q, area);
  else if (q.type === 'timeline') renderTimeline(q, area);
  else if (q.type === 'match') renderMatch(q, area);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MCQ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMCQ(q, area) {
  answered = false;
  const progress = ((qIndex / questions.length) * 100).toFixed(1);
  area.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
      <div class="question-header">–í—ä–ø—Ä–æ—Å ${qIndex + 1} –æ—Ç ${questions.length}</div>
      <button class="hint-btn" onclick="toggleHint()">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
    </div>
    <div class="progress-wrap"><div class="progress-fill" style="width:${progress}%"></div></div>
    <p class="question-text">${q.q}</p>
    <div class="choices" id="choices">
      ${q.options.map((opt, i) => `
        <button class="choice-btn" onclick="selectAnswer(this, '${opt.replace(/'/g,"&#39;")}', '${q.answer.replace(/'/g,"&#39;")}', ${i})" id="choice${i}">
          ${opt}
        </button>
      `).join('')}
    </div>
    <div class="hint-text" id="hintText">üîç ${q.hint}</div>
    <div class="feedback" id="feedback"></div>
    <button class="next-btn" id="nextBtn" onclick="nextQ()">–°–ª–µ–¥–≤–∞—â –≤—ä–ø—Ä–æ—Å ‚Üí</button>
  `;
}

function toggleHint() {
  const h = document.getElementById('hintText');
  h.classList.toggle('visible');
}

function selectAnswer(btn, chosen, answer, idx) {
  if (answered) return;
  answered = true;
  const isCorrect = chosen === answer;
  const fb = document.getElementById('feedback');
  const btns = document.querySelectorAll('.choice-btn');

  btns.forEach(b => {
    b.disabled = true;
    if (b.textContent.trim() === answer) b.classList.add('correct');
  });

  if (isCorrect) {
    btn.classList.add('correct');
    score += 10;
    correct++;
    fb.className = 'feedback correct-fb show';
    fb.innerHTML = '<span class="feedback-icon">‚úÖ</span> –ë—Ä–∞–≤–æ! –û—Ç–≥–æ–≤–æ—Ä—ä—Ç –µ –≤–µ—Ä–µ–Ω!';
  } else {
    btn.classList.add('wrong');
    score = Math.max(0, score - 3);
    wrong++;
    fb.className = 'feedback wrong-fb show';
    fb.innerHTML = `<span class="feedback-icon">‚ùå</span> –ó–∞ —Å—ä–∂–∞–ª–µ–Ω–∏–µ –Ω–µ –µ –≤—è—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª–Ω–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä –µ: <strong>${answer}</strong>`;
  }

  userLog.push({ q: questions[qIndex], correct: isCorrect });
  updateScoreBar();
  document.getElementById('nextBtn').classList.add('visible');
}

function nextQ() {
  qIndex++;
  renderQuestion();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMELINE DRAG-DROP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTimeline(q, area) {
  const cardHTML = shuffle(q.items).map(ev =>
    `<div class="event-card" draggable="true" data-year="${ev.year}" id="card${ev.year}"
       ondragstart="dragStart(event,'${ev.year}')"
       ondragend="dragEnd(event)">
      ${ev.event.length > 60 ? ev.event.slice(0, 60) + '‚Ä¶' : ev.event}
    </div>`
  ).join('');

  const slotsHTML = q.sorted.map(ev =>
    `<div class="timeline-slot">
      <div class="slot-date">${ev.year} –≥.</div>
      <div class="slot-line"></div>
      <div class="slot-dot"></div>
      <div class="slot-drop" id="slot${ev.year}" data-year="${ev.year}"
        ondragover="dragOver(event)"
        ondragleave="dragLeave(event)"
        ondrop="drop(event,'${ev.year}')">
        <span style="color:rgba(201,146,42,.35);font-style:italic;font-size:.85rem">–ü—É—Å–Ω–∏ —Å—ä–±–∏—Ç–∏–µ—Ç–æ —Ç—É–∫‚Ä¶</span>
      </div>
    </div>`
  ).join('');

  area.innerHTML = `
    <div class="question-header">–ù–∞—Ä–µ–¥–µ—Ç–µ —Å—ä–±–∏—Ç–∏—è—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª–µ–Ω —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ–Ω —Ä–µ–¥</div>
    <p class="timeline-instructions">–ü–ª—ä–∑–Ω–µ—Ç–µ –∏ –ø—É—Å–Ω–µ—Ç–µ –≤—Å—è–∫–æ —Å—ä–±–∏—Ç–∏–µ –¥–æ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∞—Ç–∞ –¥–∞—Ç–∞.</p>
    <div class="cards-pool" id="cardsPool"
      ondragover="dragOver(event)"
      ondragleave="dragLeave(event)"
      ondrop="dropPool(event)">
      ${cardHTML}
    </div>
    <div class="timeline-slots">${slotsHTML}</div>
    <button class="check-btn" onclick="checkTimeline()">‚úî –ü—Ä–æ–≤–µ—Ä–∏ –Ω–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ</button>
    <div class="feedback" id="feedback"></div>
    <button class="next-btn" id="nextBtn" onclick="nextQ()">–í–∏–∂ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ ‚Üí</button>
  `;
}

function dragStart(e, year) {
  dragItem = year;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.setData('text/plain', year);
}

function dragEnd(e) {
  e.currentTarget.classList.remove('dragging');
}

function dragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

function drop(e, slotYear) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const year = e.dataTransfer.getData('text/plain');
  const card = document.getElementById('card' + year);
  if (!card) return;

  // If slot already has a card, return the old card to pool
  const slot = document.getElementById('slot' + slotYear);
  const existing = slot.querySelector('.event-card');
  if (existing) {
    document.getElementById('cardsPool').appendChild(existing);
  }

  slot.innerHTML = '';
  slot.appendChild(card);
}

function dropPool(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  const year = e.dataTransfer.getData('text/plain');
  const card = document.getElementById('card' + year);
  if (card) document.getElementById('cardsPool').appendChild(card);
}

function checkTimeline() {
  const q = questions[qIndex];
  let allCorrect = true;
  let placed = 0;

  q.sorted.forEach(ev => {
    const slot = document.getElementById('slot' + ev.year);
    const card = slot.querySelector('.event-card');
    if (card) {
      placed++;
      if (card.dataset.year === String(ev.year)) {
        slot.classList.add('filled-correct');
        slot.classList.remove('filled-wrong');
      } else {
        slot.classList.add('filled-wrong');
        slot.classList.remove('filled-correct');
        allCorrect = false;
      }
    } else {
      allCorrect = false;
    }
  });

  const fb = document.getElementById('feedback');
  if (allCorrect && placed === q.sorted.length) {
    score += 20;
    correct++;
    fb.className = 'feedback correct-fb show';
    fb.innerHTML = '<span class="feedback-icon">‚úÖ</span> –û—Ç–ª–∏—á–Ω–æ! –í—Å–∏—á–∫–∏ —Å—ä–±–∏—Ç–∏—è —Å–∞ –Ω–∞—Ä–µ–¥–µ–Ω–∏ –ø—Ä–∞–≤–∏–ª–Ω–æ!';
  } else if (placed === 0) {
    fb.className = 'feedback wrong-fb show';
    fb.innerHTML = '<span class="feedback-icon">‚ÑπÔ∏è</span> –ù–µ —Å—Ç–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∏–∫–∞–∫–≤–∏ –∫–∞—Ä—Ç–∏. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.';
    return;
  } else {
    score = Math.max(0, score - 5);
    wrong++;
    fb.className = 'feedback wrong-fb show';
    fb.innerHTML = `<span class="feedback-icon">‚ùå</span> –ò–º–∞ –≥—Ä–µ—à–∫–∏ –≤ –Ω–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ. –ó–µ–ª–µ–Ω–æ = –ø—Ä–∞–≤–∏–ª–Ω–æ, —á–µ—Ä–≤–µ–Ω–æ = –≥—Ä–µ—à–Ω–æ.`;
  }

  userLog.push({ q: questions[qIndex], correct: allCorrect });
  updateScoreBar();
  document.querySelector('.check-btn').disabled = true;
  document.getElementById('nextBtn').classList.add('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MATCH GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMatch(q, area) {
  matchSel = { left: null, right: null };
  matchDone = {};

  const leftCol  = q.pairs.map((p, i) =>
    `<div class="match-item" id="left${i}" data-idx="${i}" data-side="left" onclick="selectMatch(this, ${i}, 'left')">${p.left}</div>`
  ).join('');

  const rightPairs = shuffle(q.pairs.map((p, i) => ({ ...p, origIdx: i })));
  const rightCol = rightPairs.map((p, i) =>
    `<div class="match-item" id="right${p.origIdx}" data-idx="${p.origIdx}" data-side="right" onclick="selectMatch(this, ${p.origIdx}, 'right')">${p.right}</div>`
  ).join('');

  area.innerHTML = `
    <div class="question-header">–°–≤—ä—Ä–∂–∏ –≥–æ–¥–∏–Ω–∞—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª–Ω–æ—Ç–æ —Å—ä–±–∏—Ç–∏–µ ‚Äì –ö—Ä—ä–≥ ${qIndex + 1}</div>
    <p style="font-style:italic;font-size:.88rem;color:var(--parchment-dark);margin-bottom:16px">–ö–ª–∏–∫–Ω–∏ –Ω–∞ –¥–∞—Ç–∞ –∏ —Å–ª–µ–¥ —Ç–æ–≤–∞ –Ω–∞ —Å—ä–æ—Ç–≤–µ—Ç–Ω–æ—Ç–æ —Å—ä–±–∏—Ç–∏–µ.</p>
    <div class="match-grid">
      <div>
        <div class="match-col-header">üìÖ –ì–æ–¥–∏–Ω–∞</div>
        ${leftCol}
      </div>
      <div>
        <div class="match-col-header">üìú –°—ä–±–∏—Ç–∏–µ</div>
        ${rightCol}
      </div>
    </div>
    <div class="feedback" id="feedback"></div>
    <button class="next-btn" id="nextBtn" onclick="nextQ()">${qIndex + 1 >= questions.length ? '–í–∏–∂ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ ‚Üí' : '–°–ª–µ–¥–≤–∞—â –∫—Ä—ä–≥ ‚Üí'}</button>
  `;
}

function selectMatch(el, idx, side) {
  if (matchDone[idx] && matchDone[idx].correct !== undefined) return;

  if (side === 'left') {
    if (matchSel.left !== null) document.getElementById('left' + matchSel.left).classList.remove('selected');
    matchSel.left = idx;
    el.classList.add('selected');
  } else {
    if (matchSel.right !== null) document.getElementById('right' + matchSel.right).classList.remove('selected');
    matchSel.right = idx;
    el.classList.add('selected');
  }

  if (matchSel.left !== null && matchSel.right !== null) {
    checkMatch();
  }
}

function checkMatch() {
  const li = matchSel.left;
  const ri = matchSel.right;
  const lEl = document.getElementById('left' + li);
  const rEl = document.getElementById('right' + ri);
  const isCorrect = (li === ri);

  lEl.classList.remove('selected');
  rEl.classList.remove('selected');

  if (isCorrect) {
    lEl.classList.add('matched-correct');
    rEl.classList.add('matched-correct');
    score += 5;
    correct++;
    matchDone[li] = { correct: true };
  } else {
    lEl.classList.add('matched-wrong');
    rEl.classList.add('matched-wrong');
    setTimeout(() => {
      lEl.classList.remove('matched-wrong');
      rEl.classList.remove('matched-wrong');
    }, 700);
    score = Math.max(0, score - 2);
    wrong++;
  }

  matchSel = { left: null, right: null };
  updateScoreBar();

  const q = questions[qIndex];
  const allDone = Object.keys(matchDone).length === q.pairs.length;
  if (allDone) {
    const fb = document.getElementById('feedback');
    fb.className = 'feedback correct-fb show';
    fb.innerHTML = '<span class="feedback-icon">‚úÖ</span> –í—Å–∏—á–∫–∏ –¥–≤–æ–π–∫–∏ —Å–∞ —Å–≤—ä—Ä–∑–∞–Ω–∏!';
    document.getElementById('nextBtn').classList.add('visible');
    userLog.push({ q: questions[qIndex], correct: true });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderResults() {
  const total    = questions.length;
  const pct      = total ? Math.round((correct / total) * 100) : 0;
  const stars    = pct >= 90 ? 3 : pct >= 60 ? 2 : pct >= 30 ? 1 : 0;
  const medal    = pct >= 90 ? 'üèÜ' : pct >= 60 ? 'ü•à' : pct >= 30 ? 'ü•â' : 'üìú';
  const comment  = pct >= 90
    ? '–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! –ò–º–∞—à –∑–Ω–∞–Ω–∏—è, –¥–æ—Å—Ç–æ–π–Ω–∏ –∑–∞ —Ö—Ä–æ–Ω–∏—Å—Ç –Ω–∞ –ü–ª–∏—Å–∫–∞!'
    : pct >= 60
    ? '–î–æ–±—Ä–µ! –ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞–π –¥–∞ –∏–∑—É—á–∞–≤–∞—à –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ –Ω–∞—à–∏—Ç–µ –ø—Ä–µ–¥—Ü–∏.'
    : pct >= 30
    ? '–ó–Ω–∞–µ—à –æ—Å–Ω–æ–≤–Ω–æ—Ç–æ. –ü—Ä–æ—á–µ—Ç–∏ –ø–∞–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏ –æ–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.'
    : '–ò—Å—Ç–æ—Ä–∏—è—Ç–∞ —á–∞–∫–∞ –¥–∞ –±—ä–¥–µ –æ—Ç–∫—Ä–∏—Ç–∞. –ù–µ —Å–µ –æ—Ç–∫–∞–∑–≤–∞–π!';

  const starsHTML = [1,2,3].map(s =>
    `<span class="star ${s <= stars ? 'lit' : ''}">‚òÖ</span>`
  ).join('');

  const reviewHTML = userLog.map((entry, i) => {
    const cls = entry.correct ? 'r-correct' : 'r-wrong';
    const icon = entry.correct ? '‚úÖ' : '‚ùå';
    const label = entry.q.type === 'mcq' ? (entry.q.q.replace(/<[^>]+>/g, '')) : (entry.q.type === 'timeline' ? '–ù–∞—Ä–µ–¥–µ—Ç–µ —Å—ä–±–∏—Ç–∏—è—Ç–∞' : '–°–≤—ä—Ä–∂–µ—Ç–µ –¥–≤–æ–π–∫–∏—Ç–µ');
    return `<div class="review-item ${cls}">${icon} ${label}</div>`;
  }).join('');

  document.getElementById('gameArea').innerHTML = `
    <div class="results-screen">
      <div class="results-title">‚öî –ö—Ä–∞–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç ‚öî</div>
      <span class="medal">${medal}</span>
      <div class="results-score-big">${score} —Ç.</div>
      <div class="stars-container">${starsHTML}</div>
      <p class="results-comment">${comment}<br><small style="font-size:.82em;opacity:.7">${correct} –≤–µ—Ä–Ω–∏ –æ—Ç ${total} –≤—ä–ø—Ä–æ—Å–∞ (${pct}%)</small></p>
      <div class="review-list">${reviewHTML}</div>
      <div style="display:flex;justify-content:center;flex-wrap:wrap;gap:10px">
        <button class="restart-btn" onclick="resetGame()">üîÑ –ò–≥—Ä–∞–π –æ—Ç–Ω–æ–≤–æ</button>
        <button class="restart-btn" onclick="setMode('timeline')" style="background:linear-gradient(135deg,#0d3a2a,#062018);border-color:#2e7d52;color:#a5d6b7">‚è≥ –ù–∞—Ä–µ–¥–µ—Ç–µ</button>
        <button class="restart-btn" onclick="setMode('match')" style="background:linear-gradient(135deg,#1a0d2a,#0d0618);border-color:#6a3fa0;color:#ce93d8">üîó –°–≤—ä—Ä–∂–µ—Ç–µ</button>
      </div>
    </div>
  `;
  document.getElementById('scoreBar').style.display = 'none';
  document.querySelector('.mode-select').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
resetGame();
</script>
</body>
</html>
